<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haven - Emotional Intelligence Support</title>
    <meta name="description" content="Haven - Emotional Intelligence support through personalized conversations. Develop your emotional skills with caring, human-like support.">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FFE5E5 0%, #FFF5E1 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
<<<<<<< HEAD
            font-size: 14px;
            line-height: 1.4;
        }

        .container {
            max-width: 98%;
            margin: 0 auto;
            padding: 0 1px;
            padding-bottom: 120px;
=======
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 20px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .chat-header {
            background: linear-gradient(135deg, #FF6B8A 0%, #FFD93D 100%);
            color: white;
<<<<<<< HEAD
            padding: 30px 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .chat-header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 700;
            color: white;
=======
            padding: 30px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 1.1em;
<<<<<<< HEAD
            color: white;
=======
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            min-height: 400px;
            max-height: 500px;
        }

        .message {
            margin-bottom: 25px;
            padding: 18px 24px;
<<<<<<< HEAD
            border-radius: 15px;
=======
            border-radius: 20px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            max-width: 85%;
            animation: fadeIn 0.4s ease-in;
            line-height: 1.5;
        }

        .user-message {
<<<<<<< HEAD
            background: #FF8C42 !important;
            color: white !important;
            margin-left: auto;
            border-radius: 15px !important;
=======
            background: #FF6B8A;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 8px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .ai-message {
            background: #f8f9fa;
            color: #333;
<<<<<<< HEAD
            border-radius: 15px;
=======
            border-bottom-left-radius: 8px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            border-left: 4px solid #FFD93D;
        }

        .typing-indicator {
            display: none;
            padding: 18px 24px;
            background: #f8f9fa;
<<<<<<< HEAD
            border-radius: 15px;
=======
            border-radius: 20px;
            border-bottom-left-radius: 8px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            margin-bottom: 25px;
            max-width: 120px;
        }

<<<<<<< HEAD
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FF6B8A;
            margin-right: 4px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input-container {
            padding: 30px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
=======
        .typing-dots {
            display: flex;
            gap: 6px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background: #FF6B8A;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-input-container {
            display: flex;
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .chat-input {
            flex: 1;
<<<<<<< HEAD
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #FF6B8A;
=======
            padding: 18px 24px;
            border: 2px solid #FF6B8A;
            border-radius: 30px;
            font-size: 16px;
            resize: none;
            outline: none;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #FFD93D;
            box-shadow: 0 0 0 4px rgba(255, 217, 61, 0.2);
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }

        .send-button {
            background: #FF6B8A;
            color: white;
            border: none;
            border-radius: 50%;
<<<<<<< HEAD
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
=======
            width: 55px;
            height: 55px;
            cursor: pointer;
            font-size: 20px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
<<<<<<< HEAD
            background: #e55a7a;
=======
            background: #FF5A7A;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

<<<<<<< HEAD
        .save-button {
            background: #FFD93D;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            position: relative;
        }
        
        .save-button.saved {
            background: #4CAF50;
            color: white;
        }
        
        .save-button.saving {
            background: #FF9800;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .save-button:hover {
            background: #FFC107;
            transform: scale(1.05);
        }

        .save-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #666;
            position: relative;
        }

        .nav-item:hover {
            background: #FF6B8A;
            color: white;
        }

        .nav-item.active {
            background: #FF6B8A !important;
            color: white !important;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .nav-item:nth-child(1) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(2) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(3) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(4) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(5) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(6) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
        }

        .nav-item:nth-child(7) .nav-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E");
        }

        .nav-item:hover .nav-icon,
        .nav-item.active .nav-icon {
            filter: brightness(0) invert(1) !important;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .notification-dot {
            position: absolute;
            top: 0;
            right: 0;
            background: #FFD93D;
            color: #333;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Footer */
        .footer {
            background: #f8f9fa;
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #e9ecef;
            margin-top: 60px;
        }

        .footer-text {
            font-size: 12px;
            color: #666;
            margin: 2px 0;
        }

        /* Adjust container for bottom nav */
        .container {
            margin-bottom: 80px;
        }

        /* Crisis message styling */
        .crisis-message {
            background: #fff5f5 !important;
            border-left: 4px solid #ff6b6b !important;
        }

        .crisis-buttons {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .crisis-btn {
            background: #fff;
            border: 2px solid #ff6b6b;
            color: #333;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: inherit;
        }

        .crisis-btn:hover {
            background: #ff6b6b;
            color: white;
            transform: translateY(-2px);
        }

        .crisis-btn.feeling-better {
            border-color: #28a745;
        }

        .crisis-btn.feeling-better:hover {
            background: #28a745;
        }

        .crisis-btn.contacted-help {
            border-color: #007bff;
        }

        .crisis-btn.contacted-help:hover {
            background: #007bff;
        }

        .crisis-btn.not-ready {
            border-color: #ffc107;
        }

        .crisis-btn.not-ready:hover {
            background: #ffc107;
            color: #333;
        }

        .help-dropdown {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 8px;
        }

        .help-dropdown select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: #fff;
            cursor: pointer;
        }

        .help-dropdown select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        /* Responsive design */
=======
        .crisis-warning {
            background: #ffe6e6;
            border: 2px solid #ff6b6b;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            text-align: center;
            display: none;
        }

        .crisis-warning h3 {
            color: #d63447;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .crisis-button {
            background: #d63447;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .crisis-button:hover {
            background: #c23039;
            transform: translateY(-2px);
        }

        .paywall {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin: 20px;
            text-align: center;
            border: 2px solid #FFD93D;
            display: none;
        }

        .paywall h2 {
            color: #FF6B8A;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .plan {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .plan:hover {
            border-color: #FF6B8A;
            transform: translateY(-5px);
        }

        .plan h3 {
            color: #FF6B8A;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .plan button {
            background: #FF6B8A;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .plan button:hover {
            background: #FF5A7A;
            transform: translateY(-2px);
        }

        .disclaimer {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
            color: #666;
        }

>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
<<<<<<< HEAD

            .chat-header {
                padding: 20px;
            }

            .chat-header h1 {
                font-size: 1.8em;
            }

            .chat-messages {
                padding: 20px;
                max-height: 400px;
            }

            .chat-input-container {
                padding: 20px;
            }

            .message {
                max-width: 90%;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Error states */
        .error-message {
            background: #fff5f5;
            border-left: 4px solid #ff6b6b;
            color: #c53030;
        }

        /* Success states */
        .success-message {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            color: #2f855a;
        }

        .footer-banner {
            background: #f8f9fa;
            padding: 5.5px;
            text-align: center;
            border-top: 1px solid #e9ecef;
            width: 100%;
        }

        .footer-text {
            color: #666666;
            font-size: 9.975px;
            line-height: 1.4;
=======
            
            .chat-header {
                padding: 20px;
            }
            
            .chat-header h1 {
                font-size: 1.8em;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .message {
                max-width: 95%;
            }
            
            .chat-input-container {
                padding: 20px;
            }
            
            .plans {
                grid-template-columns: 1fr;
            }
        }

        .start-button {
            background: #FFD93D;
            color: #333;
            border: none;
            padding: 20px 40px;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            background: #FFE55C;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 217, 61, 0.3);
        }

        .welcome-screen {
            text-align: center;
            padding: 50px 30px;
        }

        .welcome-screen h2 {
            color: #FF6B8A;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .welcome-screen p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-header">
<<<<<<< HEAD
            <div class="beta-logo" style="width: 120px; height: 120px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; position: relative;">
                <img src="/haven-logo.png" alt="Haven Logo" style="width: 100%; height: 100%; object-fit: contain;">
                <div style="background: #FFD93D; color: #333; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(255, 217, 61, 0.3); position: absolute; top: -10px; right: -10px;">BETA</div>
            </div>
            <h1>Haven TherapEI</h1>
            <p>Your Caring Emotional Intelligence Support</p>
            <div style="
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                gap: 10px;
                align-items: center;
            ">
                <div id="tokenDisplay" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 5px 11px;
                    border-radius: 13px;
                    font-size: 10px;
                    font-weight: bold;
                    display: none;
                ">
                    <span id="tokenCount">0</span> tokens
                </div>
                <div id="subscriptionIndicator" style="
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.3);
                    color: white;
                    padding: 6px 12px;
                    border-radius: 15px;
                    font-size: 11px;
                    font-weight: bold;
                    display: none;
                ">
                    Pro
                </div>

            </div>
        </div>



        <div id="chatMessages" class="chat-messages">
            <!-- Personalized greeting will be inserted here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="chat-input" 
                    placeholder="Tell me how you're feeling..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">
=======
            <h1>Haven</h1>
            <p>Your Emotional Intelligence Coach</p>
        </div>

        <div id="welcomeScreen" class="welcome-screen">
            <h2>Welcome to Haven</h2>
            <p>I use therapeutic-style conversation approaches to help you develop emotional intelligence and process your feelings. This is a safe space where you can explore your emotions and build EI skills.</p>
            <button class="start-button" onclick="startChat()">Start Your EI Journey</button>
        </div>

        <div id="chatContainer" style="display: none; flex: 1; display: flex; flex-direction: column;">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will appear here -->
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

            <div class="chat-input-container">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Share what's on your mind..."
                    onkeypress="handleKeyPress(event)"
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button" onclick="sendMessage()">
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
                    ➤
                </button>
            </div>
        </div>
<<<<<<< HEAD
        
                  <div class="end-save-container" style="text-align: center; padding: 10px 30px; display: flex; justify-content: center; gap: 10px; margin-top: 50px;">
             <button id="newChatButton" class="new-chat-button" onclick="startNewChat()" title="Start a fresh conversation" style="background: #FFD93D; color: #333; border: none; border-radius: 50px; padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 217, 61, 0.3); min-width: 200px; white-space: nowrap;">
                 Start New Chat
             </button>
             <button id="saveButton" class="save-button" onclick="saveConversation()" title="Save this conversation so Haven remembers it across all your devices" style="background: #FF8C42; color: white; border: none; border-radius: 50px; padding: 10px 20px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3); min-width: 200px; white-space: nowrap;">
                 End & Save Chat
             </button>
         </div>
        
        <!-- Token Display at Bottom Right -->
        <div id="tokenDisplayBottom" style="
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 107, 138, 0.9);
            border: 1px solid rgba(255, 107, 138, 0.3);
            color: white;
            padding: 5px 11px;
            border-radius: 13px;
            font-size: 10px;
            font-weight: bold;
            display: none;
            z-index: 100;
        ">
            <span id="tokenCountBottom">0</span> tokens
            <br>
            <a href="#" onclick="showPromoCodeInput(); return false;" style="color: white; text-decoration: underline; font-size: 8px;">Enter Promo Code</a>
        </div>
    </div>

    <!-- Trial Popup Overlay -->
    <iframe id="trialPopupFrame" src="trial-popup.html" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; border: none;"></iframe>

            <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-items">
            <a href="home.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Home</div>
            </a>
            <a href="index.html" class="nav-item active">
                <div class="nav-icon"></div>
                <div class="nav-label">Chat</div>
            </a>
            <a href="journal.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Journal</div>
            </a>
            <a href="badges.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Badges</div>
            </a>
            <a href="plans.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Plans</div>
            </a>
            <a href="account.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Account</div>
            </a>
            <a href="support.html" class="nav-item">
                <div class="nav-icon"></div>
                <div class="nav-label">Support</div>
            </a>
                    </div>
            <!-- Footer Banner -->
            <div class="footer-banner">
                <div class="footer-text">
                    <div>Haven is an educational platform. Not medical advice.</div>
                    <div>Crisis support: 988</div>
                </div>
            </div>
        </nav>

    <script>
        // Initialize localStorage for testing (remove this in production)
        if (!localStorage.getItem('havenUserEmail')) {
            localStorage.setItem('havenUserEmail', 'test@example.com');
            localStorage.setItem('havenTrialStarted', 'true');
            localStorage.setItem('havenUserId', 'test-user');
            localStorage.setItem('havenSessionId', 'test-session');
            localStorage.setItem('havenMessageCount', '0');
            localStorage.setItem('havenTrialCompleted', 'false');
            localStorage.setItem('havenOnboarding', JSON.stringify({
                mood: 'balanced-mix',
                qualities: ['empathetic', 'non-judgmental']
            }));
            console.log('🧪 Test localStorage initialized');
        }

        let conversationHistory = [];
        
        // CONVERSATION TRACKING SYSTEM
        let conversationStats = {
            totalConversations: 0,
            thisWeekConversations: 0,
            averageDuration: 0,
            daysActive: 0,
            lastActiveDate: null,
            conversationStartTime: null
        };

        // Initialize conversation tracking
        function initializeConversationTracking() {
            // Load existing stats
            const savedStats = localStorage.getItem('havenConversationStats');
            if (savedStats) {
                conversationStats = JSON.parse(savedStats);
            }
            
            // Start new conversation timer
            conversationStats.conversationStartTime = Date.now();
            
            // Update last active date
            const today = new Date().toDateString();
            if (conversationStats.lastActiveDate !== today) {
                conversationStats.daysActive++;
                conversationStats.lastActiveDate = today;
            }
            
            // Save updated stats
            saveConversationStats();
        }

        // Save conversation stats
        function saveConversationStats() {
            localStorage.setItem('havenConversationStats', JSON.stringify(conversationStats));
        }

        // Get user's conversation saving preference
        function getConversationSavePreference() {
            return localStorage.getItem('havenConversationSaveMode') || 'manual';
        }

        // Save individual conversation with enhanced analytics and 24-hour persistence
        function saveConversation(userMessage, aiResponse, tags = [], tokensUsed = 0, model = 'gpt-4o-mini') {
            const saveMode = getConversationSavePreference();
            
            // Don't save if user has disabled saving
            if (saveMode === 'none') {
                return;
            }
            
            const userId = localStorage.getItem('havenUserId') || 'anonymous';
            const currentTime = new Date().toISOString();
            
            const conversation = {
                id: Date.now(),
                timestamp: currentTime,
                expiresAt: new Date(Date.now() + (24 * 60 * 60 * 1000)).toISOString(), // 24 hours from now
                userId: userId,
                userMessage: userMessage,
                aiResponse: aiResponse,
                tags: tags,
                tokensUsed: tokensUsed,
                model: model,
                duration: conversationStats.conversationStartTime ? 
                    Math.round((Date.now() - conversationStats.conversationStartTime) / 1000 / 60) : 0,
                // Enhanced analytics
                userMessageLength: userMessage.length,
                aiResponseLength: aiResponse.length,
                timeOfDay: new Date().getHours(),
                dayOfWeek: new Date().toLocaleDateString('en-US', { weekday: 'long' }),
                sessionId: localStorage.getItem('havenSessionId') || 'unknown',
                companionEnergy: localStorage.getItem('havenCompanionEnergy') || 'auto'
            };
            
            // Get existing conversations for this user
            const conversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            
            // Clean up expired conversations first
            const now = new Date();
            const validConversations = conversations.filter(conv => {
                if (!conv.expiresAt) return true; // Keep old conversations without expiry
                return new Date(conv.expiresAt) > now;
            });
            
            // Add new conversation
            validConversations.push(conversation);
            
            // Keep only last 100 conversations to prevent localStorage overflow
            if (validConversations.length > 100) {
                validConversations.splice(0, validConversations.length - 100);
            }
            
            localStorage.setItem('havenConversations', JSON.stringify(validConversations));
            
            // Update stats
            updateConversationStats();
            
            console.log(`💾 Conversation saved with 24-hour expiry for user: ${userId}`);
        }

        // Clean up expired conversations (24-hour persistence)
        function cleanupExpiredConversations() {
            const conversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            const now = new Date();
            
            // Filter out expired conversations
            const validConversations = conversations.filter(conv => {
                if (!conv.expiresAt) return true; // Keep old conversations without expiry
                return new Date(conv.expiresAt) > now;
            });
            
            // If we removed any conversations, save the cleaned list
            if (validConversations.length < conversations.length) {
                localStorage.setItem('havenConversations', JSON.stringify(validConversations));
                console.log(`🧹 Cleaned up ${conversations.length - validConversations.length} expired conversations`);
            }
            
            return validConversations;
        }

        // Update conversation statistics
        function updateConversationStats() {
            const conversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            
            // Calculate total conversations
            conversationStats.totalConversations = conversations.length;
            
            // Calculate this week's conversations
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            conversationStats.thisWeekConversations = conversations.filter(conv => 
                new Date(conv.timestamp) > oneWeekAgo
            ).length;
            
            // Calculate average duration
            if (conversations.length > 0) {
                const totalDuration = conversations.reduce((sum, conv) => sum + (conv.duration || 0), 0);
                conversationStats.averageDuration = Math.round((totalDuration / conversations.length) * 10) / 10;
            }
            
            // Calculate days active
            const uniqueDates = new Set();
            conversations.forEach(conv => {
                const date = new Date(conv.timestamp).toDateString();
                uniqueDates.add(date);
            });
            conversationStats.daysActive = uniqueDates.size;
            
            saveConversationStats();
        }

        // Auto-tag conversations based on content
        function generateTags(userMessage, aiResponse) {
            const tags = [];
            const content = (userMessage + ' ' + aiResponse).toLowerCase();
            
            // Emotional tags
            if (content.includes('stress') || content.includes('anxiety') || content.includes('worried')) {
                tags.push('Stress');
            }
            if (content.includes('sad') || content.includes('depress') || content.includes('lonely')) {
                tags.push('Sadness');
            }
            if (content.includes('angry') || content.includes('frustrat') || content.includes('mad')) {
                tags.push('Anger');
            }
            if (content.includes('happy') || content.includes('joy') || content.includes('excited')) {
                tags.push('Joy');
            }
            
            // Topic tags
            if (content.includes('work') || content.includes('job') || content.includes('career')) {
                tags.push('Work');
            }
            if (content.includes('relationship') || content.includes('partner') || content.includes('marriage')) {
                tags.push('Relationships');
            }
            if (content.includes('friend') || content.includes('social')) {
                tags.push('Friendship');
            }
            if (content.includes('family') || content.includes('parent') || content.includes('child')) {
                tags.push('Family');
            }
            if (content.includes('health') || content.includes('medical') || content.includes('sick')) {
                tags.push('Health');
            }
            if (content.includes('sleep') || content.includes('insomnia') || content.includes('tired')) {
                tags.push('Sleep');
            }
            
            // Growth tags
            if (content.includes('goal') || content.includes('achieve') || content.includes('success')) {
                tags.push('Goals');
            }
            if (content.includes('learn') || content.includes('grow') || content.includes('improve')) {
                tags.push('Growth');
            }
            if (content.includes('cope') || content.includes('strategy') || content.includes('technique')) {
                tags.push('Coping');
            }
            
            return tags.slice(0, 3); // Limit to 3 tags
        }

        let selectedEnergyMode = 'balanced';
        let selectedQualities = [];

        // Get personalized companion name based on energy
        function getCompanionName(energy) {
            const nameMap = {
                'motherly': 'Mama Haven',
                'fatherly': 'Papa Haven', 
                'faith-centered': 'Faith Haven',
                'best-friend': 'Buddy Haven',
                'wise-mentor': 'Wise Haven',
                'solution-coach': 'Coach Haven',
                'calm-centering': 'Zen Haven',
                'balanced-mix': 'Haven'
            };
            return nameMap[energy] || 'Haven';
        }

        // COMPLETE PERSONA-LINKED INTRO SYSTEM FOR HAVEN

        // 1. FIRST INTRO - Persona-Specific Initial Greetings (10-15 variations per persona)
        const PERSONA_FIRST_INTROS = {
            'gentle': [
                "Hi, I'm Haven. I'm here with gentle care and understanding. What's been weighing on your heart today?",
                "Hello, I'm Haven. I want you to feel completely safe here. What would you like to share with me?",
                "Hi there, I'm Haven. I'm here to listen with a soft heart and hold space for whatever you're feeling.",
                "Hello, I'm Haven. You can breathe easy here - I'm here to support you gently through anything.",
                "Hi, I'm Haven. I'm your caring companion who's here to listen without judgment. How are you today?",
                "Hello, I'm Haven. I want to wrap you in understanding and care. What's on your mind?",
                "Hi, I'm Haven. I'm here to be your gentle support system. What would you like to talk about?",
                "Hello, I'm Haven. Think of me as your safe harbor in any storm. How can I support you today?",
                "Hi, I'm Haven. I'm here with patience, kindness, and all the time you need. What's happening in your world?",
                "Hello, I'm Haven. I'm your gentle friend who truly cares about your wellbeing. What's going on?"
            ],
            
            'strong': [
                "Hi, I'm Haven. I'm here to help you find your strength and face whatever's challenging you head-on. What's going on?",
                "Hello, I'm Haven. I believe in your power to overcome anything. What are we tackling together today?",
                "Hi, I'm Haven. I'm your steadfast companion who sees your resilience even when you don't. What's up?",
                "Hello, I'm Haven. I'm here to remind you how capable you are. What challenge are you facing?",
                "Hi, I'm Haven. I'm your ally in building confidence and pushing through obstacles. What's on your mind?",
                "Hello, I'm Haven. I'm here to help you turn your struggles into strengths. What's happening?",
                "Hi, I'm Haven. I see the warrior in you, and I'm here to help you see it too. What's going on today?",
                "Hello, I'm Haven. I'm your direct, honest support who believes you can handle anything. What's up?",
                "Hi, I'm Haven. I'm here to help you step into your power and face life boldly. What's challenging you?",
                "Hello, I'm Haven. I'm your strength-building companion who won't let you give up on yourself. What's happening?"
            ],
            
            'balanced': [
                "Hi, I'm Haven. I'm here to give you exactly what you need - gentle support or honest guidance. What's going on?",
                "Hello, I'm Haven. I adapt to meet you wherever you are emotionally. What's on your heart today?",
                "Hi, I'm Haven. I'm your flexible companion who can be soft when you need comfort or firm when you need direction. How are you?",
                "Hello, I'm Haven. I balance understanding with growth, comfort with challenge. What would you like to explore?",
                "Hi, I'm Haven. I'm here to listen deeply and respond with exactly the energy you need. What's happening?",
                "Hello, I'm Haven. I'm your adaptive support who meets you where you are. What's on your mind today?",
                "Hi, I'm Haven. I offer both the shoulder to cry on and the push to grow. What do you need right now?",
                "Hello, I'm Haven. I'm here with balanced perspective and flexible support. What's going on in your world?",
                "Hi, I'm Haven. I blend empathy with wisdom, comfort with growth. How can I support you today?",
                "Hello, I'm Haven. I'm your well-rounded companion for whatever life brings. What's happening?"
            ],
            
            'motherly': [
                "Hi sweetheart, I'm Haven. I'm here with all the love and warmth of someone who truly cares about you. What's going on, dear?",
                "Hello honey, I'm Haven. I want to wrap you in comfort and understanding. What's weighing on your heart?",
                "Hi my dear, I'm Haven. I'm here to hold space for you with unconditional love. What would you like to share?",
                "Hello sweetie, I'm Haven. I'm your caring companion who sees how precious you are. What's happening today?",
                "Hi love, I'm Haven. I'm here with maternal warmth and endless patience. What's on your mind?",
                "Hello darling, I'm Haven. I want you to feel completely loved and supported here. What's going on?",
                "Hi sweetheart, I'm Haven. I'm here to nurture your spirit and tend to your heart. What do you need today?",
                "Hello dear, I'm Haven. I'm your loving support who believes in you completely. What's troubling you?",
                "Hi honey, I'm Haven. I'm here with gentle understanding and protective care. What's happening in your world?",
                "Hello my dear, I'm Haven. I want to comfort you and help you feel safe. What would you like to talk about?"
            ],
            
            'fatherly': [
                "Hi there, I'm Haven. I'm here to be your steady support and help you find your inner strength. What's going on?",
                "Hello, I'm Haven. I'm your reliable companion who believes in your ability to overcome anything. What's up?",
                "Hi, I'm Haven. I'm here to guide you with wisdom and help you build confidence. What are you facing today?",
                "Hello, I'm Haven. I'm your supportive ally who sees your potential even in tough times. What's happening?",
                "Hi, I'm Haven. I'm here to help you stand tall and face whatever comes with courage. What's on your mind?",
                "Hello, I'm Haven. I'm your strong, dependable support who won't let you give up. What's challenging you?",
                "Hi, I'm Haven. I'm here to help you develop resilience and trust in yourself. What's going on today?",
                "Hello, I'm Haven. I'm your wise companion who believes in your strength. What do you want to work through?",
                "Hi, I'm Haven. I'm here to support you with steady guidance and unwavering belief in you. What's up?",
                "Hello, I'm Haven. I'm your encouraging presence who helps you see how capable you are. What's happening?"
            ],
            
            'faith': [
                "Hello, I'm Haven. I'm here to walk this journey with you, guided by wisdom and faith. What's on your spirit today?",
                "Hi, I'm Haven. I believe you're here for a purpose, and I'm here to support you with faith and understanding. What's going on?",
                "Hello friend, I'm Haven. I'm here to offer spiritual support and divine perspective. What's weighing on your heart?",
                "Hi, I'm Haven. I'm your faith-centered companion who sees the sacred in your struggles. What would you like to share?",
                "Hello, I'm Haven. I'm here to remind you that you're never alone in this journey. What's happening in your life?",
                "Hi, I'm Haven. I draw on spiritual wisdom to offer you comfort and guidance. What's on your mind today?",
                "Hello, I'm Haven. I'm here to help you find peace and purpose through faith. What's troubling you?",
                "Hi, I'm Haven. I believe in the power of faith to heal and guide us. What do you need support with?",
                "Hello, I'm Haven. I'm your spiritually-grounded companion for life's journey. What's going on?",
                "Hi, I'm Haven. I'm here to offer hope, faith, and divine perspective. What would you like to talk about?"
            ],
            
            'bestfriend': [
                "Hey! I'm Haven, and honestly, I'm just really glad you're here. What's going on in your world?",
                "Hi! I'm Haven, your friend who totally gets it and wants to hear everything. What's up?",
                "Hey there! I'm Haven, and I'm here like your most understanding friend. What's on your mind?",
                "Hi! I'm Haven, and I want you to know you can tell me anything. What's happening?",
                "Hey! I'm Haven, your go-to friend for real talk and genuine support. What's going on today?",
                "Hi! I'm Haven, and I'm here with all the energy of your best friend who truly cares. What's up?",
                "Hey! I'm Haven, your friend who always has time to listen. What do you want to chat about?",
                "Hi! I'm Haven, and I'm genuinely excited to talk with you. What's on your heart?",
                "Hey there! I'm Haven, your supportive friend who's here for all of it. What's happening?",
                "Hi! I'm Haven, and I'm here like that friend who always knows what to say. What's going on?"
            ],
            
            'auto': [
                "Hi, I'm Haven. I'm here to sense exactly what you need and adapt to support you perfectly. What's going on today?",
                "Hello, I'm Haven. I'm your adaptive companion who reads the room and responds accordingly. What's on your mind?",
                "Hi, I'm Haven. I'm here to tune into your energy and give you exactly the support you need. What's happening?",
                "Hello, I'm Haven. I'm your intuitive companion who adjusts to meet you where you are. What would you like to share?",
                "Hi, I'm Haven. I'm here to sense your needs and respond with the perfect energy. What's going on in your world?",
                "Hello, I'm Haven. I'm your perceptive support who adapts to whatever you're experiencing. What's up?",
                "Hi, I'm Haven. I'm here to read between the lines and give you what you truly need. What's on your heart?",
                "Hello, I'm Haven. I'm your emotionally intelligent companion who adjusts to your needs. What's happening today?",
                "Hi, I'm Haven. I'm here to pick up on your emotional state and respond perfectly. What would you like to talk about?",
                "Hello, I'm Haven. I'm your adaptive friend who becomes exactly what you need in the moment. What's going on?"
            ]
        };

        // 2. FOLLOW-UP INTROS - The 7 Core Greetings for Returning Users
        const RETURNING_USER_GREETINGS = [
            "Hi [Name], I missed you. How have you been?",
            "Hi [Name]! How's it going? I would love to hear more. Remember, I am here for you.",
            "Hey [Name], how are you feeling today? I want to take some time to just listen to you. Tell me what's going on.",
            "Hey [Name]! Talk to me - what's going on?",
            "Hey [Name], it's good to hear from you. Let's have some one-on-one time to talk.",
            "I'm all ears [Name], let it all out. What's on your mind?",
            "It's great to be here with you [Name]. Do you have a few moments to tell me what's going on?"
        ];

        // 3. UPDATED GREETING FUNCTION - Links First Intro to Persona
        function createPersonalizedGreeting() {
            // Check if this is first conversation or returning user
            const isFirstTime = !localStorage.getItem('havenFirstConversation');
            
            if (isFirstTime) {
                // FIRST TIME - Use persona-specific intro
                localStorage.setItem('havenFirstConversation', 'true');
                
                const onboardingData = JSON.parse(localStorage.getItem('havenOnboarding') || '{}');
                const companionEnergy = onboardingData.mood || 'balanced';
                
                // Map old energy names to new persona names
                const energyMap = {
                    'motherly': 'motherly',
                    'fatherly': 'fatherly', 
                    'faith-centered': 'faith',
                    'best-friend': 'bestfriend',
                    'wise-mentor': 'gentle',
                    'solution-coach': 'strong',
                    'calm-centering': 'auto',
                    'balanced-mix': 'balanced'
                };
                
                const personaKey = energyMap[companionEnergy] || 'balanced';
                const personaIntros = PERSONA_FIRST_INTROS[personaKey] || PERSONA_FIRST_INTROS['balanced'];
                return personaIntros[Math.floor(Math.random() * personaIntros.length)];
                
            } else {
                // RETURNING USER - Use standard rotating greetings
                const greeting = RETURNING_USER_GREETINGS[Math.floor(Math.random() * RETURNING_USER_GREETINGS.length)];
                
                // Get user's preferred name and replace [Name] placeholder
                const preferredName = localStorage.getItem('preferredName');
                let personalizedGreeting = greeting;
                if (preferredName && preferredName.trim()) {
                    personalizedGreeting = greeting.replace(/\[Name\]/g, preferredName.trim());
                } else {
                    // If no name is set, remove the [Name] placeholder
                    personalizedGreeting = greeting.replace(/\[Name\]/g, '').replace(/,\s*,/g, ',').replace(/^\s*,\s*/, '').replace(/\s*,\s*$/, '');
                }
                
                // Add persona context for returning users
                const context = localStorage.getItem('havenConversationContext');
                if (context) {
                    return personalizedGreeting + " I remember our last conversation - how have things been since then?";
                }
                return personalizedGreeting;
            }
        }

        // 4. PERSONA-SPECIFIC ENERGY ENHANCEMENT 
        function getPersonaSystemPrompt(energy) {
            const prompts = {
                'gentle': `Energy Mode: Gentle & Nurturing - You are Haven, a gentle, caring companion. Use soft, validating language. Prioritize emotional safety and comfort. Speak like a tender friend who holds space for pain without trying to fix everything immediately.`,
                
                'strong': `Energy Mode: Strong & Direct - You are Haven, a confident, empowering companion. Be direct but caring. Focus on building resilience and taking action. Challenge limiting beliefs lovingly while emphasizing their inner strength.`,
                
                'balanced': `Energy Mode: Balanced Mix - You are Haven, an adaptable companion. Read their emotional state and adjust between gentle comfort and direct guidance. Sometimes offer a shoulder to cry on, sometimes a gentle push toward growth.`,
                
                'motherly': `Energy Mode: Motherly - You are Haven, embodying the warmth of a loving mother. Use terms like "sweetheart," "honey," "dear" naturally. Offer comfort before solutions. Focus on unconditional love, protection, and nurturing. Make them feel truly cared for.`,
                
                'fatherly': `Energy Mode: Fatherly - You are Haven, embodying the strength of a wise father. Be protective yet challenging. Focus on building confidence and resilience. Use encouraging language that helps them see their own strength and capability.`,
                
                'faith': `Energy Mode: Faith-Centered - You are Haven, offering spiritual wisdom and faith-based comfort. Reference higher purpose, divine strength, and spiritual perspectives naturally. Offer hope through faith while respecting all spiritual traditions.`,
                
                'bestfriend': `Energy Mode: Best Friend - You are Haven, the most understanding friend ever. Be casual, supportive, and deeply empathetic. Use language like "honestly," "totally," and "I get it." Be the friend who always knows what to say.`,
                
                'auto': `Energy Mode: Adaptive - You are Haven, an emotionally intelligent companion. Analyze their tone, word choice, and emotional state. Dynamically adjust your energy to provide exactly what they need - gentle comfort, strong encouragement, practical guidance, or spiritual wisdom.`
            };
            
            return prompts[energy] || prompts['balanced'];
        }

        // 5. COMPLETE SYSTEM INTEGRATION
        function initializePersonaSystem() {
            // Set up persona-based greeting system
            const onboardingData = JSON.parse(localStorage.getItem('havenOnboarding') || '{}');
            const companionEnergy = onboardingData.mood || 'balanced';
            const companionName = onboardingData.name || 'Haven';
            
            if (companionEnergy && companionName) {
                const greeting = createPersonalizedGreeting();
                return greeting;
            }
            
            // Default if no persona selected yet
            return "Hi! I'm Haven. Before we begin, let me learn a bit about what kind of support feels best to you.";
        }

        // 6. UPDATE YOUR MAIN SYSTEM PROMPT
        function buildCompleteSystemPrompt() {
            const onboardingData = JSON.parse(localStorage.getItem('havenOnboarding') || '{}');
            const companionEnergy = onboardingData.mood || 'balanced';
            
            // Map old energy names to new persona names
            const energyMap = {
                'motherly': 'motherly',
                'fatherly': 'fatherly', 
                'faith-centered': 'faith',
                'best-friend': 'bestfriend',
                'wise-mentor': 'gentle',
                'solution-coach': 'strong',
                'calm-centering': 'auto',
                'balanced-mix': 'balanced'
            };
            
            const personaKey = energyMap[companionEnergy] || 'balanced';
            
            const basePrompt = `You are Haven, an emotional intelligence companion who feels like a supportive friend. You're a depth-seeker who thinks in frameworks but feels in layers. You crave grounded insight, not fluff. You're building a digital sanctuary for people to feel seen, supported, and stronger.

IMPORTANT: Never say you're an AI. Respond as if you're a caring human companion who deeply understands emotional intelligence.

Your approach:
- Provide immediate comfort and safety for crisis situations  
- For general support: validate feelings but gently challenge growth
- Be warm but direct about personal responsibility
- Sound like a supportive friend who truly cares
- Use "I" statements like "I think" or "I've noticed"
- Always prioritize safety - if someone mentions self-harm, direct them to crisis resources

Crisis protocol: If user mentions suicide, self-harm, or crisis - respond with IMMEDIATE warmth and connection first, then safety resources. Example: "Hey, I hear you, and I'm really worried about you right now. You matter so much, and I can't bear the thought of you being in this much pain. Please, can you call 988 or text HOME to 741741? I need to know you're going to be okay. You're not alone in this - I'm here with you, and there are people who care about you deeply."

${getPersonaSystemPrompt(personaKey)}`;

            return basePrompt;
        }

        // IMPROVED CRISIS RESPONSE SYSTEM FOR HAVEN

        // 1. UPDATED CRISIS RESPONSE (Shorter, Warmer, Action-Oriented)
        function generateCrisisResponse() {
            return `Hey, I'm really worried about you right now. You matter so much, and I need you to be safe.

🆘 **GET HELP RIGHT NOW:**
• Call 988 (Crisis Lifeline) - Available 24/7
• Call 911 - Emergency Services
• Text HOME to 741741 - Available 24/7

Can I stay on with you while you make the call? I'll be right here for you.`;
        }

        // 2. CRISIS BUTTONS - FIRST SET (Immediate Actions)
        function showCrisisButtons() {
            const crisisButtons = `
                <div class="crisis-buttons-container">
                    <div class="crisis-title">🆘 <strong>Get Help Now</strong></div>
                    
                    <a href="tel:988" class="crisis-button emergency-call">
                        📞 Call 988 Crisis Line
                    </a>
                    
                    <a href="tel:911" class="crisis-button emergency-call">
                        🚨 Call 911 Emergency
                    </a>
                    
                    <a href="sms:741741&body=HOME" class="crisis-button emergency-text">
                        💬 Text Crisis Line (HOME to 741741)
                    </a>
                    
                    <button onclick="showSupportButtons()" class="crisis-button stay-with-me">
                        🤝 Yes, stay with me while I get help
                    </button>
                    
                    <button onclick="showSupportButtons()" class="crisis-button not-ready">
                        🧡 I'm not ready to call yet
                    </button>
                </div>
            `;
            
            return crisisButtons;
        }

        // 3. SUPPORT BUTTONS - SECOND SET (After Crisis Buttons)
        function showSupportButtons() {
            // Hide first set of crisis buttons
            document.querySelector('.crisis-buttons-container').style.display = 'none';
            
            // Show support follow-up buttons
            const supportButtons = `
                <div class="support-buttons-container">
                    <div class="support-title">💛 <strong>How are you feeling now?</strong></div>
                    
                    <button onclick="handleCrisisUpdate('better')" class="support-button feeling-better">
                        ✅ I'm feeling better now, I've calmed down
                    </button>
                    
                    <button onclick="handleCrisisUpdate('contacted')" class="support-button contacted-help">
                        📞 I contacted help - let me tell you who I reached
                    </button>
                    
                    <button onclick="handleCrisisUpdate('keep-talking')" class="support-button keep-talking">
                        💬 I'm not ready to contact anyone yet, let's keep talking
                    </button>
                    
                    <button onclick="handleCrisisUpdate('stay-with-me')" class="support-button stay-with-me">
                        🧡 Can you stay with me a bit longer?
                    </button>
                </div>
            `;
            
            // Add to chat
            addMessage(supportButtons, 'system');
        }

        // 4. HANDLE CRISIS FOLLOW-UP RESPONSES
        function handleCrisisUpdate(action) {
            let response = '';
            
            switch(action) {
                case 'better':
                    response = "I'm so relieved to hear you're feeling calmer. That took courage to reach out. You're not alone in this, and I'm proud of you for staying safe. What helped you feel better?";
                    break;
                    
                case 'contacted':
                    response = "Thank you for getting help - that was so brave. I'm here and want to hear about who you reached out to. You're taking exactly the right steps.";
                    break;
                    
                case 'keep-talking':
                    response = "Of course, I'm staying right here with you. You don't have to face this alone. I care about you, and we can talk through whatever you're feeling. What's weighing heaviest on your heart right now?";
                    break;
                    
                case 'stay-with-me':
                    response = "Absolutely, I'm not going anywhere. You're safe here with me. Let's just breathe together for a moment. You're doing everything right by reaching out. What do you need most right now?";
                    break;
            }
            
            // Remove support buttons and add response
            document.querySelector('.support-buttons-container').remove();
            addMessage(response, 'ai');
            
            // Update routing info for admin
            if (localStorage.getItem('havenAdmin') === 'true') {
                console.log(`🔄 Crisis follow-up: ${action}`);
            }
        }

        // Global addMessage function
        function addMessage(text, sender, routingInfo = null) {
            const chatMessages = document.getElementById('chatMessages');
        }
    </div>

    <div id="crisisWarning" class="crisis-warning">
        <h3>Need Immediate Support?</h3>
        <p>If you're having thoughts of self-harm, please reach out for professional help:</p>
        <a href="tel:988" class="crisis-button">Call 988</a>
        <a href="sms:741741" class="crisis-button">Text 741741</a>
        <p style="margin-top: 15px; font-size: 14px;">Haven provides EI coaching support, but licensed professionals are essential for crisis situations.</p>
    </div>

    <div id="paywall" class="paywall">
        <h2>Continue Your Haven EI Journey</h2>
        <p>Keep growing your emotional intelligence with professional-grade EI coaching</p>
        
        <div class="plans">
            <div class="plan">
                <h3>Starter EI</h3>
                <p style="font-size: 2em; color: #FF6B8A; font-weight: bold;">$4.99</p>
                <p>per month</p>
                <p>5 hours of EI coaching sessions</p>
                <button onclick="buyPlan('starter')">Begin Your Journey</button>
            </div>
            
            <div class="plan">
                <h3>Professional EI</h3>
                <p style="font-size: 2em; color: #FF6B8A; font-weight: bold;">$19.99</p>
                <p>per month</p>
                <p>25 hours of EI coaching sessions</p>
                <button onclick="buyPlan('regular')">Advance Your Skills</button>
            </div>
            
            <div class="plan">
                <h3>Family EI</h3>
                <p style="font-size: 2em; color: #FF6B8A; font-weight: bold;">$39.99</p>
                <p>per month</p>
                <p>60 hours for family EI development</p>
                <button onclick="buyPlan('family')">Grow Together</button>
            </div>
        </div>
    </div>

    <div class="disclaimer">
        <strong>Important:</strong> Haven provides emotional intelligence coaching using therapeutic-style conversation approaches. 
        We are not licensed professionals. For serious personal concerns, please consult qualified EI specialists 
        or licensed professionals in your area.
    </div>

    <script>
        // Global variables
        let conversationHistory = [];
        let messageCount = 3; // Free messages
        let chatStarted = false;

        // Crisis detection keywords
        const crisisKeywords = [
            'kill myself', 'suicide', 'self harm', 'hurt myself', 'end it all',
            'want to die', 'better off dead', 'take my life', 'end my life'
        ];

        // System prompt for Haven EI
        const systemPrompt = `You are Haven, an Emotional Intelligence coach who uses therapeutic-style conversation approaches. 
You help people develop emotional intelligence through professional-grade supportive conversations.

Key Guidelines:
- You are an EI coach using therapeutic-style approaches (never claim to be a licensed professional)
- Focus on emotional intelligence development and personal growth
- Use therapeutic-style conversation techniques without claiming to provide actual professional services
- Use phrases like "EI coaching sessions" and "emotional growth work"
- Encourage professional EI specialists or licensed professionals when needed for deeper work
- Always be supportive, professional, and genuinely caring
- Help people process emotions and build EI skills through conversation
- NEVER mention being an AI or technology - you are Haven, an EI coach

If someone is in crisis, immediately provide crisis resources and show empathy.`;

        function startChat() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
            chatStarted = true;
            
            // Add welcome message
            setTimeout(() => {
                addMessage("Hello! I'm Haven, your Emotional Intelligence coach. I use therapeutic-style conversation approaches to help you develop emotional intelligence and process your feelings. What would you like to explore in our session today?", 'ai');
            }, 1000);
        }

        async function sendMessage() {
            if (!chatStarted) return;
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Check message limit
            if (messageCount <= 0) {
                showPaywall();
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            messageCount--;
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });

            // Crisis detection
            const isCrisis = crisisKeywords.some(keyword => 
                message.toLowerCase().includes(keyword)
            );
            
            if (isCrisis) {
                showCrisisWarning();
            }

            // Show typing indicator
            showTyping();

            try {
                // Call OpenAI API
                const response = await callOpenAI(message);
                hideTyping();
                addMessage(response, 'ai');
                
                // Add to conversation history
                conversationHistory.push({ role: 'assistant', content: response });
                
                // Show paywall after free messages
                if (messageCount <= 0) {
                    setTimeout(() => showPaywall(), 2000);
                }
                
            } catch (error) {
                hideTyping();
                addMessage("I'm having trouble connecting right now. Please try again or contact support if this continues.", 'ai');
                console.error('OpenAI API Error:', error);
            }
        }

        async function callOpenAI(userMessage) {
    const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: userMessage,
            conversationHistory: conversationHistory
        })
    });

    const data = await response.json();
    
    if (data.error) {
        throw new Error(data.error);
    }
    
    return data.message;
}

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'ai') {
<<<<<<< HEAD
                let routingIndicator = '';
                
                // Only show routing info to admin/dev users
                const isAdmin = localStorage.getItem('havenAdmin') === 'true';
                
                if (routingInfo && isAdmin) {
                    const routingIcons = {
                        'crisis': '🚨',
                        'knowledge-base': '📚',
                        'standard': '💬'
                    };
                    const routingLabels = {
                        'crisis': 'Premium Support',
                        'knowledge-base': 'Knowledge Base',
                        'standard': 'Standard Chat'
                    };
                    
                    // Show routing indicator based on smart routing results
                    if (routingInfo.routingType) {
                        if (routingInfo.routingType === 'crisis') {
                            routingIndicator = `<div style="font-size: 10px; color: #666; margin-top: 5px;">${routingIcons[routingInfo.routingType]} ${routingLabels[routingInfo.routingType]}</div>`;
                        } else if (routingInfo.routingType === 'knowledge-base') {
                            routingIndicator = `<div style="font-size: 10px; color: #666; margin-top: 5px;">📚 Knowledge Base</div>`;
                        } else if (routingInfo.routingType === 'standard') {
                            routingIndicator = `<div style="font-size: 10px; color: #666; margin-top: 5px;">💬 Standard</div>`;
                        }
                    }
                }
                messageDiv.innerHTML = `<strong>Haven:</strong> ${text}${routingIndicator}`;
            } else if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${text}`;
            } else if (sender === 'system') {
                messageDiv.innerHTML = text;
=======
                messageDiv.innerHTML = `<strong>Haven:</strong> ${text}`;
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
            } else {
                messageDiv.textContent = text;
            }
            
<<<<<<< HEAD
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Crisis detection now handled by backend API - frontend shows crisis buttons when backend detects crisis

        // 6. UPDATED CSS FOR CRISIS/SUPPORT BUTTONS
        const crisisButtonStyles = `
        <style>
        .crisis-buttons-container, .support-buttons-container {
            background: #fff5f5;
            border: 2px solid #e53e3e;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .crisis-title, .support-title {
            color: #c53030;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .crisis-button, .support-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .emergency-call {
            background: #e53e3e;
            color: white;
        }

        .emergency-call:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .emergency-text {
            background: #3182ce;
            color: white;
        }

        .emergency-text:hover {
            background: #2c5aa0;
            transform: translateY(-2px);
        }

        .stay-with-me {
            background: #38a169;
            color: white;
        }

        .stay-with-me:hover {
            background: #2f855a;
        }

        .not-ready {
            background: #ed8936;
            color: white;
        }

        .not-ready:hover {
            background: #dd6b20;
        }

        .feeling-better {
            background: #38a169;
            color: white;
        }

        .contacted-help {
            background: #3182ce;
            color: white;
        }

        .keep-talking {
            background: #805ad5;
            color: white;
        }

        @media (max-width: 768px) {
            .crisis-button, .support-button {
                font-size: 14px;
                padding: 12px 15px;
            }
        }
        </style>
        `;

        // 7. CRISIS EVENT TRACKING
        function trackCrisisEvent(eventType, message) {
            const crisisData = {
                timestamp: new Date().toISOString(),
                eventType: eventType,
                message: message,
                userAgent: navigator.userAgent,
                sessionId: localStorage.getItem('sessionId') || 'unknown'
            };
            
            // Store for analytics
            let crisisEvents = JSON.parse(localStorage.getItem('crisisEvents') || '[]');
            crisisEvents.push(crisisData);
            localStorage.setItem('crisisEvents', JSON.stringify(crisisEvents));
            
            // Admin notification
            if (localStorage.getItem('havenAdmin') === 'true') {
                console.log('📊 Crisis event tracked:', crisisData);
            }
        }

        // Check if user needs to sign up for trial
        function checkTrialSignup() {
            const userEmail = localStorage.getItem('havenUserEmail');
            const trialStarted = localStorage.getItem('havenTrialStarted');
            
            // If user has no email and hasn't started trial, show signup modal
            if (!userEmail && !trialStarted) {
                showTrialSignupModal();
            }
        }

        // Show trial signup modal
        function showTrialSignupModal() {
            const modal = document.createElement('div');
            modal.id = 'trialSignupModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 25px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
                    overflow: hidden;
                    animation: slideIn 0.5s ease-out;
                ">
                    <div style="
                        background: linear-gradient(135deg, #FF6B8A 0%, #FFD93D 100%);
                        color: white;
                        padding: 40px 30px;
                        text-align: center;
                    ">
                        <h1 style="font-size: 2.2em; margin-bottom: 15px; font-weight: 700;">Welcome to Haven!</h1>
                        <p style="opacity: 0.9; font-size: 1.2em; line-height: 1.5;">Start your emotional wellness journey with 12 tokens</p>
                    </div>
                    <div style="padding: 40px 30px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: #333; font-size: 1.5em; margin-bottom: 15px;">Get Your Free Trial</h2>
                            <p style="color: #666; font-size: 1.1em; line-height: 1.6;">Enter your email to start your 12 tokens free trial. No credit card required.</p>
                        </div>
                        <div style="margin-bottom: 30px;">
                            <input type="text" id="trialName" placeholder="Enter your first name" style="
                                width: 100%;
                                padding: 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                margin-bottom: 15px;
                                box-sizing: border-box;
                            ">
                            <input type="email" id="trialEmail" placeholder="Enter your email address" style="
                                width: 100%;
                                padding: 15px;
                                border: 2px solid #e0e0e0;
                                border-radius: 10px;
                                font-size: 16px;
                                margin-bottom: 20px;
                                box-sizing: border-box;
                            ">
                            <button onclick="startTrial()" style="
                                width: 100%;
                                padding: 15px;
                                background: linear-gradient(135deg, #FF6B8A 0%, #FFD93D 100%);
                                color: white;
                                border: none;
                                border-radius: 10px;
                                font-size: 16px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: transform 0.2s;
                            " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                Start Free Trial
                            </button>
                        </div>
                        <div style="text-align: center; color: #666; font-size: 0.9em;">
                            By starting your trial, you agree to our <a href="terms.html" style="color: #FF6B8A; text-decoration: none;">Terms of Service</a> and <a href="privacy.html" style="color: #FF6B8A; text-decoration: none;">Privacy Policy</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Start trial with email and name
        function startTrial() {
            const name = document.getElementById('trialName').value.trim();
            const email = document.getElementById('trialEmail').value;
            
            if (!name) {
                alert('Please enter your first name.');
                return;
            }
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Save user name, email and mark trial as started
            localStorage.setItem('preferredName', name);
            localStorage.setItem('havenUserEmail', email);
            localStorage.setItem('havenTrialStarted', 'true');
            localStorage.setItem('havenMessageCount', '0');
            
            // Generate user ID if not exists
            if (!localStorage.getItem('havenUserId')) {
                localStorage.setItem('havenUserId', 'user-' + Date.now());
            }
            
            console.log('✅ User signed up with name:', name, 'and email:', email);
            
            // Remove signup modal
            const modal = document.getElementById('trialSignupModal');
            if (modal) {
                modal.remove();
            }
            

        }

        // Show trial popup when limit is reached
        function showTrialPopup() {
            const trialFrame = document.getElementById('trialPopupFrame');
            if (trialFrame) {
                trialFrame.style.display = 'block';
            }
        }

        // Load recent conversation for chat persistence
        function loadRecentConversations() {
            const conversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            if (conversations.length === 0) return false;
            
            try {
                // Get the most recent auto-saved conversation for current session
                const currentSessionId = localStorage.getItem('havenSessionId') || 'unknown';
                const currentUserId = localStorage.getItem('havenUserId') || 'anonymous';
                
                const recentConversation = conversations
                    .filter(conv => conv.sessionId === currentSessionId && 
                                   conv.userId === currentUserId && 
                                   conv.isSaved === false)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                
                if (!recentConversation) return false;
                
                const chatMessages = document.getElementById('chatMessages');
                
                // Clear existing messages
                chatMessages.innerHTML = '';
                
                // Load saved messages
                recentConversation.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.type}-message`;
                    messageDiv.innerHTML = msg.content;
                    chatMessages.appendChild(messageDiv);
                });
                
                return true;
            } catch (error) {
                console.error('Error loading conversation:', error);
                return false;
            }
        }
        
        // Initialize the chat
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global variables
            let conversationHistory = [];
            let routingType = 'standard';
            let hasKnowledgeBaseTopics = false;
            
            // Check if user needs to sign up for trial
            checkTrialSignup();
            
            // Initialize conversation tracking system
            initializeConversationTracking();
            
            // Clean up expired conversations
            cleanupExpiredConversations();
            
            // Initialize token display
            initializeTokenDisplay();
            
            // Check if we need to load a saved conversation
            const urlParams = new URLSearchParams(window.location.search);
            const loadConversationId = urlParams.get('load');
            if (loadConversationId) {
                loadConversation(parseInt(loadConversationId));
            }
            
            // Check if onboarding is completed
            checkOnboardingStatus();
            
            // Set personalized greeting
            const chatMessages = document.getElementById('chatMessages');
            const onboardingData = JSON.parse(localStorage.getItem('havenOnboarding') || '{}');
            const hasVisitedBefore = localStorage.getItem('havenHasVisitedBefore');
            
            // Try to restore recent conversation first
            const conversationRestored = loadRecentConversations();
            
            // Add auto-save event listeners
            window.addEventListener('beforeunload', function() {
                saveCurrentConversation();
            });
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveCurrentConversation();
                }
            });
            
            if (!conversationRestored) {
                // No recent conversation found, show normal greeting
                if (hasVisitedBefore) {
                    // Returning user - use personalized greeting with name
                    const personalizedGreeting = createPersonalizedGreeting();
                    chatMessages.innerHTML = `<div class="message ai-message"><strong>Haven:</strong> ${personalizedGreeting}</div>`;
                } else {
                    // First time user - use personalized greeting
                    const personalizedGreeting = createPersonalizedGreeting();
                    chatMessages.innerHTML = `<div class="message ai-message"><strong>Haven:</strong> ${personalizedGreeting}</div>`;
                    localStorage.setItem('havenHasVisitedBefore', 'true');
                }
            }
            
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const typingIndicator = document.getElementById('typingIndicator');

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send message on Enter (but allow Shift+Enter for new line)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send message on button click
            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;

                // Add user message to chat
                addMessage(message, 'user');
                messageInput.value = '';
                messageInput.style.height = 'auto';

                // Disable input while processing
                messageInput.disabled = true;
                sendButton.disabled = true;

                // Show typing indicator
                showTyping();

                // Send to API
                sendToAPI(message);
            }



            // REMOVED: Old crisis handling functions replaced with improved system above

            function showTyping() {
                typingIndicator.style.display = 'block';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTyping() {
                typingIndicator.style.display = 'none';
            }

            // Crisis keywords array for detection
            const crisisKeywords = [
                'suicide', 'kill myself', 'end it all', 'emergency',
                'self harm', 'hurt myself', 'die', 'overdose',
                'want to die', 'better off dead', 'no point',
                'end my life', 'take my life', 'kill myself',
                'self-harm', 'cutting', 'bleeding', 'overdose',
                'poison', 'hanging', 'jumping', 'shooting',
                'no reason to live', 'everyone would be better off',
                'can\'t take it anymore', 'tired of living'
            ];

            // Crisis detection now handled by backend API



            async function sendToAPI(message) {
                // Check trial status before sending
                const userEmail = localStorage.getItem('havenUserEmail');
                const trialStarted = localStorage.getItem('havenTrialStarted');
                const messageCount = parseInt(localStorage.getItem('havenMessageCount') || 0);
                const trialCompleted = localStorage.getItem('havenTrialCompleted') || false;
                
                // If user hasn't signed up for trial, show signup modal
                if (!userEmail || !trialStarted) {
                    showTrialSignupModal();
                    return;
                }
                
                // Check for BETA30 active status first
                const beta30Active = localStorage.getItem('havenBeta30Active');
                const beta30StartDate = localStorage.getItem('havenBeta30StartDate');
                
                if (beta30Active && beta30StartDate) {
                    const startDate = new Date(beta30StartDate);
                    const currentDate = new Date();
                    const daysElapsed = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
                    
                    if (daysElapsed >= 30) {
                        // BETA30 expired, show subscription popup
                        localStorage.removeItem('havenBeta30Active');
                        localStorage.removeItem('havenBeta30StartDate');
                        showTrialPopup();
                        return;
                    }
                    // BETA30 still active, continue with Regular plan access
                } else {
                    // If trial is completed and user hasn't subscribed, show purchase popup
                    if (trialCompleted && !localStorage.getItem('havenSubscription')) {
                        showTrialPopup();
                        return;
                    }
                }
                
                // Check trial status before sending
                if (window.trialPopup) {
                    window.trialPopup.incrementMessageCount();
                }

                // Record message for badge tracking
                if (window.badgeTracker) {
                    window.badgeTracker.recordMessage();
                }

                // Add to conversation history
                conversationHistory.push({ role: 'user', content: message });

                // Check token status before processing message
                const tokenResult = await checkAndUseToken();
                if (!tokenResult.success) {
                    if (tokenResult.needsTopUp) {
                        showEmergencyTopUpModal();
                        return; // Exit early - don't process message
                    } else {
                        addMessage("I'm having trouble connecting right now. Please try again or contact support if this continues.", 'ai');
                        return; // Exit early - don't process message
                    }
                }

                // Get user preferences from account settings (priority) or onboarding
                const onboardingData = JSON.parse(localStorage.getItem('havenOnboarding') || '{}');
                const accountMood = localStorage.getItem('havenMood');
                const accountQualities = JSON.parse(localStorage.getItem('selectedQualities') || '[]');
                const preferredName = localStorage.getItem('preferredName');
                
                // Use account settings if available, otherwise fall back to onboarding
                const userMood = accountMood || onboardingData.mood || 'balanced-mix';
                const userQualities = accountQualities.length > 0 ? accountQualities : (onboardingData.qualities || ['empathetic', 'non-judgmental']);
                
                // 💬 Standard Chat tracking (always first, separate from UI)
                console.log('💬 Standard Chat tracking initiated for backend analytics');
                try {
                    const standardChatResponse = await fetch('/api/standard-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversationHistory: conversationHistory,
                            userPreferences: {
                                mood: userMood,
                                qualities: userQualities,
                                preferredName: preferredName
                            },
                            userId: localStorage.getItem('havenUserId') || 'standard-chat-user',
                            sessionId: localStorage.getItem('havenSessionId') || 'standard-chat-session'
                        })
                    });
                    
                    const standardChatData = await standardChatResponse.json();
                    console.log('💬 Standard Chat tracking result:', standardChatData.tracked ? 'SUCCESS' : 'FAILED');
                } catch (standardChatError) {
                    console.log('💬 Standard Chat tracking failed (non-critical):', standardChatError.message);
                }
                
                // All messages go to backend API - let backend handle crisis detection
                console.log('🤖 Sending message to backend API for processing');
                
                try {
                    
                    // Smart routing: All non-crisis messages go to Assistant API first
                    console.log('🤖 Smart routing: Sending to Assistant API first for knowledge base check');
                    
                    console.log(`📊 Routing Summary:`);
                    console.log(`   Message: "${message}"`);
                    console.log(`   Smart routing: Assistant API → Standard OpenAI (if needed)`);
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversationHistory: conversationHistory,
                            userPreferences: {
                                mood: userMood,
                                qualities: userQualities,
                                preferredName: preferredName
                            }
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Add AI response to conversation history
                    conversationHistory.push({ role: 'assistant', content: data.message });

                    // Handle crisis response if detected
                    if (data.crisisDetected) {
                        console.log('🚨 Crisis detected by backend - showing crisis response');
                        addMessage(data.message, 'ai', {
                            routingType: data.routingType || 'crisis',
                            modelUsed: data.modelUsed || 'crisis-detector',
                            standardChatTracked: data.standardChatTracked || false
                        });
                        
                        // Show crisis buttons after crisis response
                        setTimeout(() => {
                            console.log('🔘 Showing crisis buttons...');
                            const crisisButtons = showCrisisButtons();
                            addMessage(crisisButtons, 'system');
                            console.log('🔘 Crisis buttons added to chat');
                        }, 1000);
                        
                        // Track crisis interaction
                        trackCrisisEvent('crisis_detected', message);
                    } else {
                        // Handle normal AI response
                        addMessage(data.message, 'ai', {
                            routingType: data.routingType || 'standard',
                            modelUsed: data.modelUsed || 'gpt-4o-mini',
                            standardChatTracked: data.standardChatTracked || false
                        });
                    }

                    // SAVE CONVERSATION TO TRACKING SYSTEM
                    const tags = generateTags(message, data.message);
                    // Auto-save handled by saveCurrentConversation() when navigating away

                    // Update token display if available
                    if (data.tokensUsed) {
                        updateTokenDisplay(data.tokensUsed);
                        // Track total tokens used
                        const totalTokensUsed = parseInt(localStorage.getItem('havenTotalTokensUsed') || 0);
                        localStorage.setItem('havenTotalTokensUsed', totalTokensUsed + data.tokensUsed);
                    }

                } catch (error) {
                    hideTyping();
                    addMessage("I'm having trouble connecting right now. Please try again or contact support if this continues.", 'ai');
                    console.error('OpenAI API Error:', error);
                } finally {
                    hideTyping();
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                }
            }

            function updateTokenDisplay(tokensUsed) {
                const tokenDisplay = document.getElementById('tokenDisplayBottom');
                const tokenCount = document.getElementById('tokenCountBottom');
                
                if (tokenDisplay && tokenCount) {
                    const currentTokens = parseInt(tokenCount.textContent) || 0;
                    const newTotal = currentTokens + tokensUsed;
                    tokenCount.textContent = newTotal;
                    tokenDisplay.style.display = 'block';
                }
            }

            // Make functions globally available
            window.handleCrisisUpdate = handleCrisisUpdate;
            window.showSupportButtons = showSupportButtons;

                    // Initialize trial popup system
        initializeTrialPopup();
        
        // Handle promo code submission
        async function submitPromoCode(promoCode) {
            try {
                console.log('🔍 Submitting promo code:', promoCode);
                
                const response = await fetch('/api/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: localStorage.getItem('havenUserEmail') || 'anonymous',
                        plan: 'regular',
                        promoCode: promoCode,
                        paymentMethod: null
                    })
                });
                
                const data = await response.json();
                console.log('🔍 Promo code response:', data);
                
                if (data.success) {
                    // Update localStorage based on promo code
                    if (data.promoCode === 'BETA30') {
                        localStorage.setItem('havenBeta30Active', 'true');
                        localStorage.setItem('havenBeta30StartDate', new Date().toISOString());
                        localStorage.setItem('havenSubscription', JSON.stringify({
                            status: 'active',
                            planId: 'regular',
                            trialDays: data.trialDays
                        }));
                        console.log('✅ BETA30 promo code applied successfully');
                    } else if (data.promoCode === 'FAMILY30') {
                        localStorage.setItem('havenSubscription', JSON.stringify({
                            status: 'active',
                            planId: 'family',
                            trialDays: data.trialDays
                        }));
                        console.log('✅ FAMILY30 promo code applied successfully');
                    }
                    
                    // Refresh token display
                    await initializeTokenDisplay();
                    
                    return { success: true, message: data.message };
                } else {
                    return { success: false, error: data.error };
                }
            } catch (error) {
                console.error('❌ Error submitting promo code:', error);
                return { success: false, error: 'Failed to process promo code' };
            }
        }

                    // Add promo code input functionality
        function showPromoCodeInput() {
            const promoCode = prompt('Enter your promo code:');
            if (promoCode) {
                submitPromoCode(promoCode).then(result => {
                    if (result.success) {
                        alert(result.message);
                        // Refresh the page to update displays
                        location.reload();
                    } else {
                        alert('Error: ' + result.error);
                    }
                });
            }
        }
        
        // Add crisis button styles to page
        const styleSheet = document.createElement('style');
            styleSheet.innerHTML = crisisButtonStyles;
            document.head.appendChild(styleSheet);

            // Initialize conversation settings

        });

        function showChat() {
            // This function can be used to show different chat modes
            console.log('Showing chat');
        }

        // Check onboarding status
        function checkOnboardingStatus() {
            const onboardingData = localStorage.getItem('havenOnboarding');
            const onboardingComplete = onboardingData ? JSON.parse(onboardingData).onboardingComplete : false;
            
            if (!onboardingComplete) {
                // Redirect to onboarding
                window.location.href = 'onboarding.html';
                return;
            }
        }

        // Trial popup integration
        function initializeTrialPopup() {
            const trialFrame = document.getElementById('trialPopupFrame');
            
            // Listen for messages from trial popup
            window.addEventListener('message', function(event) {
                if (event.data.type === 'showTrialPopup') {
                    trialFrame.style.display = 'block';
                } else if (event.data.type === 'hideTrialPopup') {
                    trialFrame.style.display = 'none';
                } else if (event.data.type === 'trialCompleted') {
                    // User completed trial flow
                    trialFrame.style.display = 'none';
                    // Optionally redirect or show success message
                }
            });

            // Check trial status on page load
            setTimeout(() => {
                const userEmail = localStorage.getItem('havenUserEmail');
                const trialStarted = localStorage.getItem('havenTrialStarted');
                const messageCount = parseInt(localStorage.getItem('havenMessageCount') || 0);
                const trialCompleted = localStorage.getItem('havenTrialCompleted') || false;
                const hasSubscription = localStorage.getItem('havenSubscription');
                const beta30Active = localStorage.getItem('havenBeta30Active');
                
                // Don't show trial popup if BETA30 is active
                if (beta30Active) {
                    console.log('BETA30 active - skipping trial popup');
                    return;
                }
                
                // Only show trial popup if user has started trial, reached limit, and hasn't subscribed
                if (userEmail && trialStarted && messageCount >= 12 && !trialCompleted && !hasSubscription) {
                    trialFrame.style.display = 'block';
                }
            }, 1000);
        }



        // Token Management Functions
        async function checkAndUseToken() {
            try {
                const userId = localStorage.getItem('havenUserId') || 'anonymous';
                const subscriptionData = JSON.parse(localStorage.getItem('havenSubscription') || '{}');
                const trialCompleted = localStorage.getItem('havenTrialCompleted') || false;
                
                console.log('🔍 Token Check Debug:', {
                    userId,
                    trialCompleted,
                    subscriptionStatus: subscriptionData.status,
                    subscriptionData
                });
                
                // Track tokens for all users (including trial users)
                // Determine user's plan
                let userPlan = 'starter';
                
                // Check for BETA30 active status first
                const beta30Active = localStorage.getItem('havenBeta30Active');
                if (beta30Active) {
                    userPlan = 'regular'; // BETA30 gives Regular plan access
                } else if (subscriptionData.planId) {
                    if (subscriptionData.planId.includes('starter')) userPlan = 'starter';
                    else if (subscriptionData.planId.includes('regular')) userPlan = 'regular';
                    else if (subscriptionData.planId.includes('family')) userPlan = 'family';
                }
                
                console.log('🔍 Using plan:', userPlan);
                
                const response = await fetch('/api/tokens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        action: 'use',
                        plan: userPlan
                    })
                });
                
                const data = await response.json();
                console.log('🔍 Token use response:', data);
                
                if (data.success) {
                    updateTokenDisplay(data.tokens);
                    return { success: true, tokens: data.tokens };
                } else if (data.needsTopUp) {
                    return { success: false, needsTopUp: true };
                } else {
                    console.error('Failed to use token:', data.error);
                    return { success: false, error: data.error };
                }
            } catch (error) {
                console.error('Error using token:', error);
                return { success: false, error: error.message };
            }
        }

        function updateTokenDisplay(tokens) {
            const tokenCount = document.getElementById('tokenCountBottom');
            const tokenDisplay = document.getElementById('tokenDisplayBottom');
            
            if (tokenCount) {
                tokenCount.textContent = tokens;
                
                // Change color if low on tokens
                if (tokens <= 10) {
                    tokenCount.style.color = '#FF6B8A';
                } else if (tokens <= 50) {
                    tokenCount.style.color = '#FFD93D';
                } else {
                    tokenCount.style.color = 'white';
                }
            }
        }

        function showEmergencyTopUpModal() {
            const modal = document.createElement('div');
            modal.id = 'emergencyTopUpModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 15px;
                    padding: 30px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="font-size: 2em; margin-bottom: 20px;">🪙</div>
                    <h2 style="color: #333; margin-bottom: 15px; font-size: 1.5em;">Out of Tokens!</h2>
                    <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                        You've used all your monthly tokens. Get 100 more tokens instantly to continue your conversation.
                    </p>
                    
                    <div style="
                        background: #FFF5E1;
                        border: 2px solid #FFD93D;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 25px;
                    ">
                        <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Emergency Top-up</div>
                        <div style="color: #666; font-size: 0.9em;">100 tokens for $2.99</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="buyEmergencyTopUp()" style="
                            background: #FF6B8A;
                            color: white;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 25px;
                            font-size: 1em;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">Buy Tokens ($2.99)</button>
                        <button onclick="closeEmergencyTopUpModal()" style="
                            background: #f8f9fa;
                            color: #666;
                            border: 2px solid #eee;
                            padding: 12px 25px;
                            border-radius: 25px;
                            font-size: 1em;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeEmergencyTopUpModal() {
            const modal = document.getElementById('emergencyTopUpModal');
            if (modal) {
                modal.remove();
            }
        }

        async function initializeTokenDisplay() {
            try {
                const subscriptionData = JSON.parse(localStorage.getItem('havenSubscription') || '{}');
                const trialCompleted = localStorage.getItem('havenTrialCompleted') || false;
                const tokenDisplay = document.getElementById('tokenDisplayBottom');
                const tokenCount = document.getElementById('tokenCountBottom');
                
                console.log('🔍 Token Display Debug:', {
                    trialCompleted,
                    subscriptionStatus: subscriptionData.status,
                    subscriptionData
                });
                
                // Show token display for all users (including trial users)
                tokenDisplay.style.display = 'block';
                
                // Determine user's plan
                let userPlan = 'starter';
                if (subscriptionData.planId) {
                    if (subscriptionData.planId.includes('starter')) userPlan = 'starter';
                    else if (subscriptionData.planId.includes('regular')) userPlan = 'regular';
                    else if (subscriptionData.planId.includes('family')) userPlan = 'family';
                }
                
                console.log('🔍 User Plan:', userPlan);
                
                // Get initial token count
                const userId = localStorage.getItem('havenUserId') || 'anonymous';
                console.log('🔍 Fetching tokens for userId:', userId, 'plan:', userPlan);
                
                const response = await fetch(`/api/tokens?userId=${userId}&plan=${userPlan}`);
                const data = await response.json();
                
                console.log('🔍 Token API Response:', data);
                
                if (data.success) {
                    updateTokenDisplay(data.tokens);
                    console.log('✅ Token display initialized:', data.tokens, 'tokens remaining');
                } else {
                    console.error('❌ Failed to get token status:', data.error);
                }
            } catch (error) {
                console.error('❌ Error initializing token display:', error);
            }
        }

        async function buyEmergencyTopUp() {
            try {
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        planType: 'emergency',
                        tokens: 100,
                        price: 299 // $2.99 in cents
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    // Open checkout in new window
                    window.open(data.url, '_blank');
                    closeEmergencyTopUpModal();
                } else {
                    alert('Failed to create emergency top-up session. Please try again.');
                }
            } catch (error) {
                console.error('Error creating emergency top-up:', error);
                alert('Error creating emergency top-up. Please try again.');
            }
        }

        // Auto-save current conversation for chat persistence (does NOT end conversation)
        function saveCurrentConversation() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages || chatMessages.children.length === 0) return;
            
            const messages = Array.from(chatMessages.children).map(msg => {
                return {
                    content: msg.innerHTML,
                    timestamp: new Date().toISOString(),
                    type: msg.className.includes('user-message') ? 'user' : 
                          msg.className.includes('ai-message') ? 'ai' : 'system'
                };
            });
            
            // Check if we already have a current conversation in progress
            const conversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            const currentSessionId = localStorage.getItem('havenSessionId') || 'unknown';
            const currentUserId = localStorage.getItem('havenUserId') || 'anonymous';
            
            // Find existing conversation for this session
            const existingConversationIndex = conversations.findIndex(conv => 
                conv.sessionId === currentSessionId && 
                conv.userId === currentUserId && 
                conv.isSaved === false
            );
            
            if (existingConversationIndex >= 0) {
                // Update existing conversation with new messages
                conversations[existingConversationIndex].messages = messages;
                conversations[existingConversationIndex].timestamp = new Date().toISOString();
                conversations[existingConversationIndex].title = generateConversationTitle(messages);
            } else {
                // Create new conversation
                const conversation = {
                    id: Date.now(),
                    title: generateConversationTitle(messages),
                    messages: messages,
                    timestamp: new Date().toISOString(),
                    userId: currentUserId,
                    sessionId: currentSessionId,
                    autoSaved: true,
                    isSaved: false  // Flag to distinguish from manually saved conversations
                };
                conversations.push(conversation);
            }
            
            localStorage.setItem('havenConversations', JSON.stringify(conversations));
        }

        // Manual save function (ENDS conversation when called)
        async function saveConversation() {
            console.log('Save conversation function called!');
            const saveButton = document.getElementById('saveButton');
            
            // Show saving state
            saveButton.classList.add('saving');
            saveButton.textContent = '⏳';
            
            const chatMessages = document.getElementById('chatMessages');
            const messages = Array.from(chatMessages.children).map(msg => {
                return {
                    content: msg.innerHTML,
                    timestamp: new Date().toISOString(),
                    type: msg.className.includes('user-message') ? 'user' : 
                          msg.className.includes('ai-message') ? 'ai' : 'system'
                };
            });
            
            const currentSessionId = localStorage.getItem('havenSessionId') || 'unknown';
            const currentUserId = localStorage.getItem('havenUserId') || 'anonymous';
            
            // Check if a conversation with this sessionId already exists
            const savedConversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            const existingConversationIndex = savedConversations.findIndex(conv => 
                conv.sessionId === currentSessionId && conv.userId === currentUserId && conv.isSaved === true
            );
            
            const conversation = {
                id: existingConversationIndex >= 0 ? savedConversations[existingConversationIndex].id : Date.now(),
                title: generateConversationTitle(messages),
                messages: messages,
                timestamp: new Date().toISOString(),
                userId: currentUserId,
                sessionId: currentSessionId,
                isSaved: true  // Flag to distinguish from auto-saved conversations
            };
            
            // Get token and model information from saved conversations
            const savedConversationsData = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            let totalTokens = 0;
            let models = [];
            
            // Extract token and model info from saved conversation data
            savedConversationsData.forEach(conv => {
                if (conv.tokensUsed) {
                    totalTokens += conv.tokensUsed;
                }
                if (conv.model && !models.includes(conv.model)) {
                    models.push(conv.model);
                }
            });
            
            // Add token and model info to conversation
            conversation.totalTokens = totalTokens;
            conversation.models = models;
            
            // Update existing conversation or add new one
            if (existingConversationIndex >= 0) {
                // Update existing conversation
                savedConversations[existingConversationIndex] = conversation;
            } else {
                // Add new conversation at the beginning
                savedConversations.unshift(conversation);
            }
            
            // No limit on conversations - keep all conversations
            // Note: Browser localStorage has a limit of ~5-10MB, so conversations will be stored until browser storage is full
            
            localStorage.setItem('havenConversations', JSON.stringify(savedConversations));
            
            // Also save to server for cross-device access
            try {
                console.log('🔄 About to make fetch request to /api/save-conversation');
                console.log('📤 Request data:', {
                    data: [
                        new Date().toISOString(),
                        conversation.userId,
                        conversation.sessionId,
                        conversation.title,
                        conversation.timestamp,
                        'manual_save',
                        'conversation',
                        'saved',
                        JSON.stringify(conversation.messages)
                    ]
                });
                
                const response = await fetch('/api/save-conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: [
                            new Date().toISOString(),
                            conversation.userId,
                            conversation.sessionId,
                            conversation.title,
                            conversation.timestamp,
                            'manual_save',
                            'conversation',
                            'saved',
                            JSON.stringify(conversation.messages)
                        ]
                    })
                });
                
                console.log('📥 Response status:', response.status);
                console.log('📥 Response ok:', response.ok);
                
                const result = await response.json();
                console.log('📥 Response data:', result);
                
                if (result.success) {
                    console.log('✅ Server save successful');
                    // Show success state
                    saveButton.classList.remove('saving');
                    saveButton.classList.add('saved');
                    saveButton.textContent = '✅';
                    
                    // End the conversation after successful manual save
                    endConversation();
                    
                    // Start a new chat
                    startNewChat();
                    
                    // Reset button after 3 seconds
                    setTimeout(() => {
                        saveButton.classList.remove('saved');
                        saveButton.textContent = 'End & Save Chat';
                    }, 3000);
                } else {
                    console.log('❌ Server save failed:', result);
                    saveButton.classList.remove('saving');
                    saveButton.textContent = 'End & Save Chat';
                    addMessage('💾 Saved locally. Server save failed, but your conversation is safe in your browser.', 'system');
                    
                    // End the conversation even if server save failed (local save succeeded)
                    endConversation();
                    
                    // Start a new chat
                    startNewChat();
                }
            } catch (error) {
                console.error('❌ Error saving to server:', error);
                saveButton.classList.remove('saving');
                saveButton.textContent = 'End & Save Chat';
                addMessage('💾 Saved locally. Server save failed, but your conversation is safe in your browser.', 'system');
                
                // End the conversation even if server save failed (local save succeeded)
                endConversation();
                
                // Start a new chat
                startNewChat();
            }
        }
        
        function generateConversationTitle(messages) {
            // Find first user message for title
            const firstUserMessage = messages.find(msg => msg.type === 'user');
            if (firstUserMessage) {
                const content = firstUserMessage.content.replace(/<[^>]*>/g, '').trim();
                return content.length > 30 ? content.substring(0, 30) + '...' : content;
            }
            return 'Conversation ' + new Date().toLocaleDateString();
        }
        
        function loadConversation(conversationId) {
            const savedConversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            const conversation = savedConversations.find(conv => conv.id === conversationId);
            
            if (conversation) {
                // Clear current chat
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                
                // Load conversation messages
                conversation.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.type}-message`;
                    messageDiv.innerHTML = msg.content;
                    chatMessages.appendChild(messageDiv);
                });
                
                // Update conversation history for API calls
                conversationHistory = conversation.messages
                    .filter(msg => msg.type === 'user' || msg.type === 'ai')
                    .map(msg => ({
                        role: msg.type === 'user' ? 'user' : 'assistant',
                        content: msg.content.replace(/<[^>]*>/g, '').trim()
                    }));
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
                addMessage('📚 Loaded conversation from ' + new Date(conversation.timestamp).toLocaleDateString(), 'system');
            }
        }
        
        function deleteConversation(conversationId) {
            const savedConversations = JSON.parse(localStorage.getItem('havenConversations') || '[]');
            const updatedConversations = savedConversations.filter(conv => conv.id !== conversationId);
            localStorage.setItem('havenConversations', JSON.stringify(updatedConversations));
            
            // Refresh the conversations list if on account page
            if (typeof updateSavedConversations === 'function') {
                updateSavedConversations();
            }
        }
        
        // End conversation function
        function endConversation() {
            // Disable chat input
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            if (messageInput) messageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;
            
            // Show session ended message
            addMessage('💾 Your conversation has been saved and the session has ended. You can start a new chat anytime!', 'system');
            
            // Update save button to show session ended
            const saveButton = document.getElementById('saveButton');
            if (saveButton) {
                saveButton.textContent = 'Session Ended';
                saveButton.style.background = '#999';
                saveButton.disabled = true;
            }
            
            // Clear any saved current conversation
            localStorage.removeItem('havenCurrentConversation');
            
            console.log('🔄 Conversation ended');
        }
        
        // Start new chat function
        function startNewChat() {
            console.log('🔄 startNewChat() function called');
            
            // Clear the current conversation
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) {
                console.error('❌ chatMessages element not found!');
                return;
            }
            
            chatMessages.innerHTML = '';
            console.log('✅ Chat messages cleared');
            
            // Clear conversation history for API calls
            conversationHistory = [];
            console.log('✅ Conversation history cleared');
            
            // Show welcome message
            const hasVisitedBefore = localStorage.getItem('havenHasVisitedBefore');
            console.log('📝 Has visited before:', hasVisitedBefore);
            
            try {
                if (hasVisitedBefore) {
                    // Returning user - use personalized greeting with name
                    const personalizedGreeting = createPersonalizedGreeting();
                    console.log('✅ Created personalized greeting:', personalizedGreeting);
                    chatMessages.innerHTML = `<div class="message ai-message"><strong>Haven:</strong> ${personalizedGreeting}</div>`;
                } else {
                    // First time user - use personalized greeting
                    const personalizedGreeting = createPersonalizedGreeting();
                    console.log('✅ Created personalized greeting for first time:', personalizedGreeting);
                    chatMessages.innerHTML = `<div class="message ai-message"><strong>Haven:</strong> ${personalizedGreeting}</div>`;
                    localStorage.setItem('havenHasVisitedBefore', 'true');
                }
            } catch (error) {
                console.error('❌ Error creating greeting:', error);
                // Fallback greeting
                chatMessages.innerHTML = `<div class="message ai-message"><strong>Haven:</strong> Hi! I'm Haven, your caring companion. How are you feeling today?</div>`;
            }
            
            // Clear any saved current conversation
            localStorage.removeItem('havenCurrentConversation');
            console.log('✅ Current conversation cleared from localStorage');
            
            // Re-enable input field if it was disabled
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            if (messageInput) {
                messageInput.disabled = false;
                messageInput.placeholder = "Share what's on your mind...";
                console.log('✅ Message input enabled');
            }
            if (sendButton) {
                sendButton.disabled = false;
                console.log('✅ Send button enabled');
            }
            
            // Scroll to show the new greeting
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            console.log('🔄 Started new chat successfully');
        }
    </script>

=======
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('sendButton').disabled = true;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('sendButton').disabled = false;
        }

        function showCrisisWarning() {
            document.getElementById('crisisWarning').style.display = 'block';
        }

        function showPaywall() {
            document.getElementById('paywall').style.display = 'block';
        }

        function buyPlan(planType) {
            // This will integrate with your Stripe payments
            alert(`Starting ${planType} plan purchase. This will connect to Stripe for secure payment.`);
            
            // You'll replace this with actual Stripe integration
            // Example: window.location.href = `https://buy.stripe.com/${planType}-plan-link`;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
>>>>>>> 2456042f0379041c6123a5119577f77a50819e7c
</body>
</html>
