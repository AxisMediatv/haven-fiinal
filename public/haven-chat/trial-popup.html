<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haven - Trial Complete</title>
    <meta name="description" content="Your Haven trial is complete. Choose a plan to continue your emotional wellness journey.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FFE5E5 0%, #FFF5E1 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .popup-container {
            background: white;
            border-radius: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            overflow-y: auto;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .popup-header {
            background: linear-gradient(135deg, #FF6B8A 0%, #FFD93D 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .popup-header h1 {
            font-size: 2.2em;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .popup-header p {
            opacity: 0.9;
            font-size: 1.2em;
            line-height: 1.5;
        }

        .popup-content {
            padding: 40px 30px;
        }

        .trial-message {
            text-align: center;
            margin-bottom: 30px;
        }

        .trial-message h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .trial-message p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .pricing-section {
            margin-bottom: 30px;
        }

        .pricing-title {
            text-align: center;
            color: #333;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .beta-badge {
            background: #FF6B8A;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
        }

        .plan-cards {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .plan-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card:hover {
            border-color: #FF6B8A;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 138, 0.2);
        }

        .plan-card.recommended {
            border-color: #FF6B8A;
            background: rgba(255, 107, 138, 0.05);
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plan-name {
            font-weight: 600;
            color: #333;
            font-size: 1.2em;
        }

        .plan-price {
            color: #FF6B8A;
            font-weight: 700;
            font-size: 1.3em;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            margin-left: 8px;
        }

        .plan-features {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .plan-features ul {
            list-style: none;
            padding: 0;
        }

        .plan-features li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .plan-features li:before {
            content: "âœ“";
            color: #28a745;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .recommended-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #FF6B8A;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            border: none;
        }

        .btn-primary {
            background: #FF6B8A;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 138, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #eee;
        }

        .btn-secondary:hover {
            border-color: #FF6B8A;
            color: #FF6B8A;
        }

        .exit-message {
            text-align: center;
            padding: 40px 30px;
            display: none;
        }

        .exit-message h2 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .exit-message p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .email-capture {
            margin-top: 20px;
        }

        .email-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .email-input:focus {
            outline: none;
            border-color: #FF6B8A;
        }

        .btn-email {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-email:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .payment-page {
            display: none;
        }

        .payment-form {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #FF6B8A;
        }

        .promo-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .promo-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            margin-top: 10px;
        }

        .promo-label {
            color: #666;
            font-size: 0.9em;
        }

        .promo-section-small {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .promo-input-small {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8em;
            background: #f9f9f9;
        }

        .promo-input-small:focus {
            outline: none;
            border-color: #FF6B8A;
            background: white;
        }

        .btn-promo-small {
            background: #FF6B8A;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-promo-small:hover {
            background: #E8447A;
            transform: translateY(-1px);
        }

        @media (max-width: 600px) {
            .popup-container {
                margin: 20px;
                max-width: none;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .plan-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="popup-overlay" id="trialPopup">
        <div class="popup-container">
            <!-- Trial Complete Message -->
            <div class="popup-header">
                <h1>ðŸŽ‰ Trial Complete!</h1>
                <p>You've experienced the power of emotional intelligence support</p>
            </div>

            <div class="popup-content" id="mainContent">
                <div class="trial-message">
                    <h2>We've had some great conversations!</h2>
                    <p>Your 12 free messages are up, but I'm here whenever you need support. Want to keep going?</p>
                </div>

                <div class="pricing-section">
                    <div class="pricing-title">
                        <div class="beta-badge">BETA PRICING - 50% OFF</div>
                        Choose Your Plan
                    </div>

                    <div class="plan-cards">
                        <div class="plan-card">
                            <div class="plan-header">
                                <div class="plan-name">Starter Plan</div>
                                <div class="plan-price">
                                    $2.99<span class="original-price">$5.99</span>
                                </div>
                            </div>
                            <div class="plan-features">
                                <ul>
                                    <li>300 tokens per month</li>
                                    <li>Basic emotional support</li>
                                    <li>Standard features</li>
                                    <li>Email support</li>
                                </ul>
                            </div>
                        </div>

                        <div class="plan-card recommended">
                            <div class="recommended-badge">MOST POPULAR</div>
                            <div class="plan-header">
                                <div class="plan-name">Regular Plan</div>
                                <div class="plan-price">
                                    $9.99<span class="original-price">$19.99</span>
                                </div>
                            </div>
                            <div class="plan-features">
                                <ul>
                                    <li>1,500 tokens per month</li>
                                    <li>Advanced emotional support</li>
                                    <li>Journal feature included</li>
                                    <li>Priority support</li>
                                    <li>Progress tracking</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="choosePlan()">Choose Plan</button>
                        <button class="btn btn-secondary" onclick="maybeLater()">Maybe Later</button>
                    </div>
                    
                    <div class="promo-section-small">
                        <input type="text" class="promo-input-small" id="promoCodeSmall" placeholder="Enter promo code">
                        <button class="btn-promo-small" onclick="applyPromoCode()">Apply</button>
                    </div>
                </div>
            </div>

            <!-- Exit Flow -->
            <div class="exit-message" id="exitMessage">
                <h2>Thanks for trying Haven!</h2>
                <p>We'll check in with you soon. Stay connected for updates and special offers.</p>
                
                <div class="email-capture">
                    <input type="email" class="email-input" id="exitEmail" placeholder="Enter your email to stay updated">
                    <button class="btn-email" onclick="captureEmail()">Stay Connected</button>
                </div>
            </div>

            <!-- Payment Page -->
            <div class="payment-page" id="paymentPage">
                <div class="popup-header">
                    <h1>ðŸ’³ Complete Your Subscription</h1>
                    <p>Secure payment powered by Stripe</p>
                </div>

                <div class="payment-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="paymentEmail" placeholder="your@email.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-input" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" class="form-input" id="expiryDate" placeholder="MM/YY" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CVC</label>
                            <input type="text" class="form-input" id="cvc" placeholder="123" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Plan Selection</label>
                        <select class="form-input" id="planSelection">
                            <option value="starter">Starter Plan - $2.99/month</option>
                            <option value="regular">Regular Plan - $9.99/month</option>
                        </select>
                    </div>

                    <div class="promo-section">
                        <label class="promo-label">Have a promo code?</label>
                        <input type="text" class="promo-input" id="promoCode" placeholder="Enter promo code (optional)">
                        <small style="color: #666; font-size: 0.8em;">Valid codes: BETA30 (30 days free), FAMILY30 (30 days free with card)</small>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="processPayment()">Complete Payment</button>
                        <button class="btn btn-secondary" onclick="goBack()">Back to Plans</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Track user message count
        let messageCount = localStorage.getItem('havenMessageCount') || 0;
        let trialCompleted = localStorage.getItem('havenTrialCompleted') || false;

        // Check if trial should be shown
        function checkTrialStatus() {
            if (messageCount >= 12 && !trialCompleted) {
                showTrialPopup();
            }
        }

        // Show trial completion popup
        function showTrialPopup() {
            document.getElementById('trialPopup').style.display = 'flex';
            localStorage.setItem('havenTrialCompleted', 'true');
        }

        // Choose Plan - Go to payment
        function choosePlan() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'block';
            
            // Pre-fill promo code if applied
            const appliedPromo = localStorage.getItem('havenPromoCode');
            if (appliedPromo) {
                document.getElementById('promoCode').value = appliedPromo;
            }
        }

        // Maybe Later - Exit flow
        function maybeLater() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('exitMessage').style.display = 'block';
            
            // Tag user as trial_declined
            tagUserAsDeclined();
        }

        // Capture email for marketing
        function captureEmail() {
            const email = document.getElementById('exitEmail').value;
            if (email) {
                // Save email to marketing list
                saveEmailToMarketing(email, 'trial_declined');
                
                // Show success message
                document.getElementById('exitMessage').innerHTML = `
                    <h2>Thanks for trying Haven!</h2>
                    <p>We'll check in with you soon with updates and special offers.</p>
                    <button class="btn btn-secondary" onclick="closePopup()">Close</button>
                `;
            }
        }

        // Process payment
        async function processPayment() {
            const email = document.getElementById('paymentEmail').value;
            const plan = document.getElementById('planSelection').value;
            const promoCode = document.getElementById('promoCode').value;

            if (!email) {
                alert('Please enter your email address.');
                return;
            }

            try {
                const response = await fetch('/api/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        plan: plan,
                        promoCode: promoCode,
                        paymentMethod: 'pm_card_visa' // In real app, this would be the actual payment method
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.promoCode) {
                        // Promo code applied
                        alert(data.message);
                        completeSubscription(email, plan, data.promoCode);
                    } else {
                        // Regular payment
                        alert('Payment processed successfully!');
                        completeSubscription(email, plan);
                    }
                } else {
                    alert(data.error || 'Payment failed. Please try again.');
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Payment processing failed. Please try again.');
            }
        }

        // Complete subscription
        function completeSubscription(email, plan, promoCode = null) {
            // Save subscription data
            const subscriptionData = {
                email: email,
                plan: plan,
                promoCode: promoCode,
                startDate: new Date().toISOString(),
                status: 'active'
            };
            
            localStorage.setItem('havenSubscription', JSON.stringify(subscriptionData));
            
            // Tag user as converted
            saveEmailToMarketing(email, 'trial_converted');
            
            // Close popup and redirect
            closePopup();
            window.location.href = 'index.html';
        }

        // Go back to plan selection
        function goBack() {
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // Close popup
        function closePopup() {
            document.getElementById('trialPopup').style.display = 'none';
        }

        // Tag user as declined
        function tagUserAsDeclined() {
            const userEmail = localStorage.getItem('havenUserEmail') || 'anonymous@haven.com';
            saveEmailToMarketing(userEmail, 'trial_declined');
        }

        // Save email to marketing list
        async function saveEmailToMarketing(email, tag) {
            try {
                const response = await fetch('/api/capture-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        tag: tag,
                        source: 'trial_completion'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('Email captured successfully:', data);
                } else {
                    console.error('Failed to capture email:', data.error);
                }
            } catch (error) {
                console.error('Error capturing email:', error);
            }
        }

        // Increment message count
        function incrementMessageCount() {
            messageCount = parseInt(messageCount) + 1;
            localStorage.setItem('havenMessageCount', messageCount);
            checkTrialStatus();
        }

        // Apply promo code
        function applyPromoCode() {
            const promoCode = document.getElementById('promoCodeSmall').value.trim().toUpperCase();
            
            if (promoCode === 'BETA30') {
                // BETA30 gives 30 days of Regular plan access for free
                const regularPlan = document.querySelector('.plan-card.recommended');
                const priceElement = regularPlan.querySelector('.plan-price');
                
                // Update price to show promo applied
                priceElement.innerHTML = 'FREE<span class="original-price">$19.99</span><span style="color: #28a745; font-size: 0.8em; margin-left: 8px;">BETA30 APPLIED</span>';
                
                // Store promo code and activate 30-day trial
                localStorage.setItem('havenPromoCode', 'BETA30');
                localStorage.setItem('havenBeta30Active', 'true');
                localStorage.setItem('havenBeta30StartDate', new Date().toISOString());
                localStorage.setItem('havenSubscription', JSON.stringify({
                    plan: 'regular',
                    promoCode: 'BETA30',
                    startDate: new Date().toISOString(),
                    status: 'active',
                    trialDays: 30
                }));
                
                // Reset message count to give full access
                localStorage.setItem('havenMessageCount', '0');
                localStorage.setItem('havenTrialCompleted', 'false');
                
                // Show success message
                const promoSection = document.querySelector('.promo-section-small');
                promoSection.innerHTML = '<div style="color: #28a745; font-size: 0.8em; text-align: center; width: 100%;">âœ“ BETA30 activated! 30 days of Regular plan access</div>';
                
                // Close popup and redirect to chat
                setTimeout(() => {
                    closePopup();
                    window.location.href = 'index.html';
                }, 2000);
                
            } else {
                alert('Invalid promo code. Please try again.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkTrialStatus();
        });

        // Export functions for use in main chat
        window.trialPopup = {
            incrementMessageCount,
            checkTrialStatus,
            showTrialPopup
        };
    </script>
</body>
</html> 